<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blockchain File Storage</title>
  </head>
  <body>
    <header>
      <h1>Blockchain File Storage</h1>
      <button id="connect-wallet-btn">Connect Wallet</button>
    </header>
    <main>
      <form id="upload-form">
        <h2>Upload a File</h2>
        <input type="file" name="file" />
        <button type="submit">Upload</button>
      </form>
      <hr />
      <h2>Files</h2>
      <ul id="file-list"></ul>
    </main>

    <script src="web3.js-1.9.0/dist/web3.min.js"></script>
    <script src="app.js"></script>
    <script>
      // Initialize web3 and connect wallet
      initWeb3().then(() => {
        document.getElementById('connect-wallet-btn').addEventListener('click', connectWallet);
        updateFileList();
      });

      // Connect wallet
      const connectWallet = async () => {
        try {
          await window.ethereum.enable();
          alert('Wallet connected successfully');
        } catch (err) {
          console.error(err);
          alert('Failed to connect wallet');
        }
      };

      // Handle form submit
      document.getElementById('upload-form').addEventListener('submit', async (event) => {
        event.preventDefault();

        const file = event.target.file.files[0];

        try {
          // Upload file to blockchain
          const txHash = await uploadFile(file);

          // Clear input field
          event.target.file.value = '';

          // Refresh file list
          updateFileList();

          alert(`File uploaded successfully with transaction hash: ${txHash}`);
        } catch (err) {
          console.error(err);
          alert('Failed to upload file');
        }
      });

      // Update file list
      const updateFileList = async () => {
        const fileList = document.getElementById('file-list');
        fileList.innerHTML = '';

        try {
          // Get number of files on blockchain
          const numFiles = await getFileCount();

          for (let i = 1; i <= numFiles; i++) {
            // Get file CID from blockchain
            const cid = await getFileCID(i);

            // Create list item and link
            const listItem = document.createElement('li');
            const link = document.createElement('a');
            link.href = `https://ipfs.infura.io/ipfs/${cid}`;
            link.target = '_blank';
            link.textContent = `File ${i}`;
            listItem.appendChild(link);

            // Add list item to file list
            fileList.appendChild(listItem);
          }
        } catch (err) {
          console.error(err);
          alert('Failed to update file list');
        }
      };
    </script>
  </body>
</html>
